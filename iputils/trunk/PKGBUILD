# Maintainer: St√©phane Gaudreault <stephane@archlinux.org>
# Maintainer: Tobias Powalowski <tpowa@archlinux.org>
# Contributor: Aaron Griffin <aaron@archlinux.org>

pkgname=iputils
# Commit date + git rev-parse --short origin/master
_rev=13e0084
pkgver=20190709
pkgrel=3
pkgdesc="Network monitoring tools, including ping"
arch=('x86_64')
license=('GPL')
url="http://www.skbuff.net/iputils/"
depends=('openssl' 'libcap' 'libidn2')
optdepends=('xinetd: for tftpd')
makedepends=('perl-sgmls' 'git' 'docbook-xsl' 'meson')
conflicts=('netkit-base' 'arping' 'netkit-tftpd')
replaces=('netkit-base')
backup=(etc/xinetd.d/tftp)
install=${pkgname}.install
source=("git+https://github.com/iputils/iputils.git#commit=${_rev}"
        tftp.xinetd
        fix-setuid-redeclared.patch
        https://github.com/iputils/iputils/commit/18f14be80466ddc8fb17a400be82764a779c8dcd.patch)
sha1sums=('SKIP'
          'fc2ae26f5609725e3f4aeaf4ab82dfa6d2e378fd'
          'ea7c400d1c397d514de718957c28730d87cef656'
          'cf00aff837580a9a9fea069d98ab1a89b353c714')

prepare() {
  cd $pkgname
  patch -Np1 -i $srcdir/fix-setuid-redeclared.patch
  #fix #66727 arping duplicate ip adress
  patch -Np1 -i $srcdir/18f14be80466ddc8fb17a400be82764a779c8dcd.patch
}

build() {
  mkdir -p build
  cd build

  arch-meson ../$pkgname -DBUILD_RARPD=true
  ninja
}

package() {
  cd build

  DESTDIR="$pkgdir" ninja install

  # FS#24768
  install -dm755 "${pkgdir}"/etc/xinetd.d/
  install -m644 "${srcdir}"/tftp.xinetd "${pkgdir}"/etc/xinetd.d/tftp
}
